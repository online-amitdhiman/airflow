from __future__ import annotations

import pendulum
import base64, os
from pathlib import Path
from airflow.decorators import dag, task
from airflow.operators.empty import EmptyOperator
from airflow.providers.snowflake.operators.snowflake import SnowflakeSqlApiOperator
from src.yfinance_loader import fetch_and_load_stock_data  # Import our function

# --- Configuration ---
SF_CONN = "SF_CONN"
SF_DB = "YFINANCE"
SF_SCHEMA = "PUBLIC"
YFINANCE_TABLE = "PRICE_HISTORY"
TICKERS_TO_FETCH = ["AAL",
"AAM",
"AAP",
"AAT",
"ABG",
"ABL",
"ABM",
"ABP",
"ABR",
"ABT",
"ACA",
"ACB",
"ACI",
"ACM",
"ACN",
"ACP",
"ACR",
"ACT",
"ACU",
"ACV",
"ADC",
"ADD",
"ADI",
"ADM",
"ADN",
"ADP",
"ADT",
"ADV",
"ADX",
"AEE",
"AEF",
"AEG",
"AEI",
"AEM",
"AEO",
"AEP",
"AER",
"AES",
"AFB",
"AFG",
"AFL",
"AGD",
"AGH",
"AGI",
"AGL",
"AGM",
"AGO",
"AGS",
"AGX",
"AHG",
"AHH",
"AHR",
"AHT",
"AIG",
"AIN",
"AIO",
"AIP",
"AIR",
"AIT",
"AIV",
"AIZ",
"AJG",
"AKA",
"AKR",
"ALB",
"ALC",
"ALE",
"ALF",
"ALG",
"ALK",
"ALL",
"ALT",
"ALV",
"ALX",
"AMC",
"AMD",
"AME",
"AMG",
"AMH",
"AMN",
"AMP",
"AMR",
"AMS",
"AMT",
"AMX",
"ANF",
"ANL",
"ANY",
"AOD",
"AON",
"AOS",
"APA",
"APD",
"APG",
"APH",
"API",
"APM",
"APO",
"APP",
"APT",
"AQB",
"AQN",
"ARE",
"ARI",
"ARL",
"ARM",
"ARQ",
"ARR",
"ARW",
"ASA",
"ASB",
"ASC",
"ASG",
"ASH",
"ASM",
"ASO",
"ASR",
"ASX",
"ATI",
"ATO",
"ATR",
"ATS",
"AUB",
"AUR",
"AVA",
"AVB",
"AVD",
"AVK",
"AVO",
"AVR",
"AVT",
"AVY",
"AWF",
"AWH",
"AWI",
"AWK",
"AWP",
"AWR",
"AWX",
"AXL",
"AXP",
"AXR",
"AXS",
"AYI",
"AZI",
"AZN",
"AZO",
"AZZ",
"BAC",
"BAH",
"BAK",
"BAM",
"BAP",
"BAX",
"BBD",
"BBN",
"BBU",
"BBW",
"BBY",
"BCC",
"BCE",
"BCG",
"BCH",
"BCO",
"BCS",
"BCV",
"BCX",
"BDC",
"BDJ",
"BDL",
"BDN",
"BDX",
"BEN",
"BEP",
"BFC",
"BFH",
"BFK",
"BFS",
"BFZ",
"BGB",
"BGC",
"BGH",
"BGI",
"BGM",
"BGR",
"BGS",
"BGT",
"BGX",
"BGY",
"BHB",
"BHC",
"BHE",
"BHF",
"BHK",
"BHM",
"BHP",
"BHR",
"BHV",
"BIO",
"BIP",
"BIT",
"BKD",
"BKE",
"BKH",
"BKN",
"BKR",
"BKT",
"BKU",
"BKV",
"BLD",
"BLE",
"BLK",
"BLW",
"BLX",
"BMA",
"BME",
"BMI",
"BMN",
"BMO",
"BMR",
"BMY",
"BNH",
"BNJ",
"BNL",
"BNR",
"BNS",
"BNT",
"BNY",
"BOC",
"BOE",
"BOF",
"BOH",
"BON",
"BOW",
"BOX",
"BPT",
"BRC",
"BRN",
"BRO",
"BRT",
"BRW",
"BRX",
"BRY",
"BSL",
"BSM",
"BST",
"BSX",
"BSY",
"BTA",
"BTE",
"BTG",
"BTI",
"BTM",
"BTO",
"BTT",
"BTU",
"BTX",
"BTZ",
"BUD",
"BUI",
"BUR",
"BVN",
"BVS",
"BWA",
"BWB",
"BWG",
"BXC",
"BXP",
"BYD",
"BYM",
"BZH",
"C^N",
"CAC",
"CAE",
"CAF",
"CAG",
"CAH",
"CAL",
"CAN",
"CAR",
"CAT",
"CBL",
"CBT",
"CBU",
"CBZ",
"CCB",
"CCD",
"CCG",
"CCI",
"CCJ",
"CCK",
"CCL",
"CCM",
"CCO",
"CCS",
"CCU",
"CCZ",
"CDE",
"CDP",
"CDT",
"CDW",
"CEE",
"CEG",
"CEP",
"CET",
"CEV",
"CFG",
"CFR",
"CGC",
"CGO",
"CHD",
"CHE",
"CHH",
"CHI",
"CHN",
"CHR",
"CHT",
"CHW",
"CHX",
"CHY",
"CIA",
"CIB",
"CIF",
"CIG",
"CII",
"CIK",
"CIM",
"CIO",
"CIX",
"CKX",
"CLB",
"CLF",
"CLH",
"CLM",
"CLS",
"CLW",
"CLX",
"CMA",
"CMC",
"CME",
"CMG",
"CMI",
"CMP",
"CMS",
"CMT",
"CMU",
"CNA",
"CNC",
"CNF",
"CNH",
"CNI",
"CNK",
"CNL",
"CNM",
"CNO",
"CNP",
"CNQ",
"CNR",
"CNS",
"CNX",
"COE",
"COF",
"CON",
"COO",
"COP",
"COR",
"CPA",
"CPB",
"CPF",
"CPK",
"CPS",
"CPT",
"CPZ",
"CQP",
"CRC",
"CRF",
"CRH",
"CRI",
"CRK",
"CRL",
"CRM",
"CRS",
"CRT",
"CSL",
"CSQ",
"CSR",
"CSV",
"CSX",
"CTM",
"CTO",
"CTS",
"CUB",
"CUE",
"CUK",
"CUZ",
"CVE",
"CVI",
"CVM",
"CVR",
"CVS",
"CVU",
"CVV",
"CVX",
"CWD",
"CWH",
"CWK",
"CWT",
"CXE",
"CXH",
"CXM",
"CXT",
"CXW",
"CYD",
"CYH",
"CYN",
"CZR",
"DAC",
"DAL",
"DAN",
"DAO",
"DAR",
"DAY",
"DBD",
"DBI",
"DBL",
"DBX",
"DCI",
"DCO",
"DDD",
"DDI",
"DDL",
"DDS",
"DDT",
"DEA",
"DEC",
"DEI",
"DEO",
"DFH",
"DFP",
"DFS",
"DGX",
"DHC",
"DHF",
"DHI",
"DHR",
"DHT",
"DHX",
"DHY",
"DIN",
"DIS",
"DIT",
"DJT",
"DKL",
"DKS",
"DLB",
"DLO",
"DLR",
"DLX",
"DLY",
"DMA",
"DMB",
"DMF",
"DMN",
"DMO",
"DNA",
"DNB",
"DNN",
"DNP",
"DOC",
"DOV",
"DOW",
"DOX",
"DPG",
"DPZ",
"DRD",
"DRH",
"DRI",
"DRS",
"DSL",
"DSM",
"DSP",
"DSS",
"DSU",
"DSX",
"DSY",
"DTB",
"DTC",
"DTE",
"DTF",
"DTG",
"DTI",
"DTM",
"DTW",
"DUK",
"DUO",
"DVA",
"DVN",
"DXC",
"DXF",
"DXR",
"DYN",
"EAD",
"EAF",
"EAI",
"EAT",
"EBC",
"EBF",
"EBR",
"EBS",
"ECF",
"ECG",
"ECL",
"ECO",
"ECX",
"EDD",
"EDF",
"EDN",
"EDU",
"EEA",
"EEX",
"EFC",
"EFR",
"EFT",
"EFX",
"EGP",
"EGY",
"EHC",
"EHI",
"EIC",
"EIG",
"EIM",
"EIX",
"EJH",
"ELA",
"ELC",
"ELF",
"ELP",
"ELS",
"ELV",
"EMD",
"EME",
"EMF",
"EML",
"EMN",
"EMO",
"EMP",
"EMR",
"EMX",
"ENB",
"ENJ",
"ENO",
"ENR",
"ENS",
"ENX",
"ENZ",
"EOD",
"EOG",
"EOI",
"EOS",
"EOT",
"EPC",
"EPD",
"EPM",
"EPR",
"EQC",
"EQH",
"EQR",
"EQS",
"EQT",
"EQV",
"EQX",
"ERC",
"ERH",
"ERJ",
"ERO",
"ESE",
"ESI",
"ESP",
"ESQ",
"ESS",
"ETB",
"ETD",
"ETG",
"ETJ",
"ETN",
"ETO",
"ETR",
"ETV",
"ETW",
"ETY",
"EVC",
"EVF",
"EVG",
"EVH",
"EVI",
"EVM",
"EVN",
"EVO",
"EVR",
"EVT",
"EVV",
"EXC",
"EXE",
"EXG",
"EXK",
"EXP",
"EXR",
"EYE",
"F^B",
"F^C",
"F^D",
"FAF",
"FAT",
"FAX",
"FBK",
"FBP",
"FCF",
"FCN",
"FCO",
"FCT",
"FCX",
"FDP",
"FDS",
"FDX",
"FER",
"FET",
"FFA",
"FFC",
"FGB",
"FGF",
"FGI",
"FGL",
"FGN",
"FHB",
"FHI",
"FHN",
"FIP",
"FIS",
"FIX",
"FLC",
"FLD",
"FLG",
"FLL",
"FLO",
"FLR",
"FLS",
"FLX",
"FMC",
"FMN",
"FMS",
"FMX",
"FMY",
"FNA",
"FNB",
"FND",
"FNF",
"FNV",
"FOA",
"FOF",
"FOR",
"FOX",
"FPF",
"FPH",
"FPI",
"FRA",
"FRD",
"FRO",
"FRT",
"FSI",
"FSK",
"FSM",
"FSP",
"FSS",
"FSV",
"FTF",
"FTI",
"FTK",
"FTS",
"FTV",
"FUL",
"FUN",
"FVN",
"FVR",
"GAB",
"GAM",
"GAN",
"GAP",
"GAU",
"GBR",
"GBX",
"GCI",
"GCL",
"GCO",
"GCT",
"GCV",
"GDC",
"GDL",
"GDO",
"GDS",
"GDV",
"GEF",
"GEG",
"GEL",
"GEN",
"GEO",
"GES",
"GEV",
"GFF",
"GFI",
"GFL",
"GFR",
"GFS",
"GGB",
"GGG",
"GGN",
"GGR",
"GGT",
"GGZ",
"GHC",
"GHG",
"GHI",
"GHM",
"GHY",
"GIB",
"GIC",
"GIL",
"GIS",
"GJH",
"GJO",
"GJP",
"GJR",
"GJT",
"GLE",
"GLO",
"GLP",
"GLQ",
"GLU",
"GLV",
"GLW",
"GME",
"GMM",
"GMS",
"GNE",
"GNK",
"GNL",
"GNS",
"GNT",
"GNW",
"GOF",
"GPC",
"GPI",
"GPK",
"GPN",
"GRC",
"GRF",
"GRI",
"GRO",
"GRX",
"GSK",
"GSL",
"GSM",
"GTE",
"GTI",
"GTN",
"GTX",
"GTY",
"GUG",
"GUT",
"GVA",
"GVH",
"GWH",
"GWW",
"GXO",
"HAE",
"HAL",
"HAO",
"HAS",
"HBB",
"HBI",
"HBM",
"HBT",
"HCA",
"HCC",
"HCI",
"HCM",
"HDB",
"HDL",
"HEI",
"HEQ",
"HES",
"HGV",
"HHH",
"HHS",
"HIG",
"HII",
"HIO",
"HIT",
"HIW",
"HIX",
"HKD",
"HLF",
"HLI",
"HLN",
"HLP",
"HLT",
"HLX",
"HMC",
"HMN",
"HMR",
"HMY",
"HNI",
"HNW",
"HOG",
"HON",
"HOV",
"HPE",
"HPF",
"HPH",
"HPI",
"HPK",
"HPP",
"HPQ",
"HPS",
"HQH",
"HQI",
"HQL",
"HQY",
"HRB",
"HRI",
"HRL",
"HST",
"HSY",
"HTB",
"HTD",
"HTH",
"HTZ",
"HUM",
"HUN",
"HUT",
"HVT",
"HWC",
"HWH",
"HWM",
"HXL",
"HYI",
"HYT",
"HZO",
"IAC",
"IAE",
"IAF",
"IAG",
"IAS",
"IBG",
"IBM",
"IBN",
"IBO",
"IBP",
"ICE",
"ICG",
"ICL",
"ICU",
"IDA",
"IDE",
"IDN",
"IDR",
"IDT",
"IEP",
"IEX",
"IFF",
"IFN",
"IFS",
"IGA",
"IGC",
"IGD",
"IGI",
"IGR",
"IGT",
"IHD",
"IHG",
"IHS",
"IHT",
"IIF",
"III",
"IIM",
"IKT",
"IMG",
"IMO",
"ING",
"INM",
"INN",
"INO",
"INR",
"INV",
"IOR",
"IOT",
"IPA",
"IPG",
"IPI",
"IPM",
"IPW",
"IPX",
"IQI",
"IQV",
"IRD",
"IRM",
"IRS",
"IRT",
"ISD",
"ITP",
"ITT",
"ITW",
"IVA",
"IVP",
"IVR",
"IVT",
"IVZ",
"IZM",
"JBI",
"JBK",
"JBL",
"JCE",
"JCI",
"JEF",
"JEQ",
"JFB",
"JFR",
"JFU",
"JGH",
"JHG",
"JHI",
"JHS",
"JHX",
"JKS",
"JLL",
"JLS",
"JMM",
"JNJ",
"JOB",
"JOE",
"JOF",
"JPC",
"JPI",
"JPM",
"JQC",
"JRI",
"JRS",
"JSM",
"JVA",
"JWN",
"JXG",
"JXN",
"JYD",
"KAI",
"KAR",
"KBH",
"KBR",
"KDP",
"KEN",
"KEP",
"KEX",
"KEY",
"KFS",
"KFY",
"KGC",
"KGS",
"KHC",
"KIM",
"KIO",
"KKR",
"KLC",
"KLG",
"KMB",
"KMI",
"KMT",
"KMX",
"KNF",
"KNW",
"KNX",
"KOD",
"KOF",
"KOP",
"KOS",
"KRC",
"KRG",
"KRO",
"KRP",
"KRT",
"KSS",
"KTB",
"KTF",
"KTH",
"KTN",
"KWE",
"KWR",
"KYN",
"KZR",
"LAB",
"LAC",
"LAD",
"LAR",
"LAW",
"LAZ",
"LDI",
"LDP",
"LEA",
"LEE",
"LEG",
"LEN",
"LEO",
"LEU",
"LFT",
"LGI",
"LGL",
"LGO",
"LHX",
"LIF",
"LII",
"LIN",
"LKQ",
"LLY",
"LMB",
"LMT",
"LNC",
"LND",
"LNG",
"LNN",
"LNT",
"LNW",
"LOB",
"LOT",
"LOW",
"LPA",
"LPG",
"LPL",
"LPX",
"LRE",
"LRN",
"LSB",
"LSE",
"LSF",
"LSH",
"LTC",
"LTH",
"LTM",
"LUD",
"LUV",
"LVO",
"LVS",
"LXP",
"LXU",
"LYB",
"LYG",
"LYV",
"LZB",
"LZM",
"MAA",
"MAC",
"MAG",
"MAN",
"MAR",
"MAS",
"MAT",
"MAV",
"MAX",
"MBC",
"MBI",
"MBX",
"MCB",
"MCD",
"MCI",
"MCK",
"MCN",
"MCO",
"MCR",
"MCS",
"MCW",
"MCY",
"MDB",
"MDT",
"MDU",
"MDV",
"MEC",
"MED",
"MEG",
"MEI",
"MET",
"MFA",
"MFC",
"MFG",
"MFH",
"MFI",
"MFM",
"MGA",
"MGF",
"MGM",
"MGR",
"MGX",
"MGY",
"MHD",
"MHF",
"MHH",
"MHI",
"MHK",
"MHN",
"MHO",
"MIN",
"MIO",
"MIR",
"MIY",
"MKC",
"MKL",
"MLI",
"MLM",
"MLP",
"MLR",
"MMA",
"MMC",
"MMD",
"MMI",
"MMM",
"MMS",
"MMT",
"MMU",
"MNR",
"MNY",
"MOB",
"MOD",
"MOH",
"MOS",
"MOV",
"MPA",
"MPB",
"MPC",
"MPU",
"MPV",
"MPW",
"MPX",
"MQT",
"MQY",
"MRC",
"MRK",
"MRM",
"MRP",
"MRT",
"MRX",
"MSA",
"MSB",
"MSC",
"MSD",
"MSI",
"MSM",
"MSN",
"MSS",
"MSW",
"MTA",
"MTB",
"MTC",
"MTD",
"MTG",
"MTH",
"MTN",
"MTR",
"MTW",
"MTX",
"MTZ",
"MUA",
"MUC",
"MUE",
"MUJ",
"MUR",
"MUX",
"MVF",
"MVO",
"MVT",
"MWA",
"MWG",
"MXC",
"MXE",
"MXF",
"MXL",
"MYD",
"MYE",
"MYI",
"MYN",
"MYO",
"NAC",
"NAD",
"NAK",
"NAN",
"NAT",
"NAZ",
"NBB",
"NBH",
"NBN",
"NBR",
"NBY",
"NCA",
"NCI",
"NCL",
"NCT",
"NCV",
"NCZ",
"NEA",
"NEE",
"NEM",
"NEN",
"NEO",
"NET",
"NEU",
"NFE",
"NFG",
"NFJ",
"NGD",
"NGG",
"NGL",
"NGS",
"NHC",
"NHI",
"NHS",
"NIC",
"NIE",
"NIM",
"NIO",
"NIU",
"NJR",
"NKE",
"NKX",
"NLY",
"NMG",
"NMI",
"NML",
"NMM",
"NMR",
"NMS",
"NMT",
"NMZ",
"NNE",
"NNI",
"NNN",
"NNY",
"NOA",
"NOC",
"NOG",
"NOK",
"NOM",
"NOV",
"NOW",
"NPB",
"NPK",
"NPO",
"NPV",
"NQP",
"NRC",
"NRG",
"NRK",
"NRO",
"NRP",
"NRT",
"NSA",
"NSC",
"NSP",
"NTB",
"NTR",
"NTZ",
"NUE",
"NUS",
"NUV",
"NUW",
"NVA",
"NVG",
"NVO",
"NVR",
"NVS",
"NVT",
"NVX",
"NWE",
"NWG",
"NWL",
"NWN",
"NWS",
"NXC",
"NXE",
"NXG",
"NXJ",
"NXL",
"NXN",
"NXP",
"NXT",
"NYC",
"NYT",
"NZF",
"OBE",
"OBK",
"OBT",
"OCC",
"OCG",
"OCS",
"OCX",
"ODC",
"ODD",
"ODP",
"ODV",
"OEC",
"OFG",
"OFS",
"OGE",
"OGI",
"OGN",
"OGS",
"OHI",
"OIA",
"OII",
"OIS",
"OKE",
"OLB",
"OLN",
"OLO",
"OLP",
"OMC",
"OMF",
"OMH",
"OMI",
"ONB",
"ONC",
"ONL",
"OPI",
"OPK",
"OPP",
"OPY",
"ORA",
"ORC",
"ORI",
"ORN",
"OSK",
"OSS",
"OST",
"OSW",
"OUT",
"OVV",
"OWL",
"OXM",
"OXY",
"OZK",
"PAA",
"PAC",
"PAG",
"PAI",
"PAL",
"PAM",
"PAR",
"PAX",
"PAY",
"PBA",
"PBF",
"PBH",
"PBI",
"PBM",
"PBR",
"PBT",
"PCB",
"PCF",
"PCG",
"PCH",
"PCK",
"PCM",
"PCN",
"PCQ",
"PCT",
"PDD",
"PDI",
"PDM",
"PDO",
"PDS",
"PDT",
"PDX",
"PEB",
"PED",
"PEG",
"PEN",
"PEO",
"PEP",
"PET",
"PFD",
"PFE",
"PFG",
"PFH",
"PFL",
"PFN",
"PFO",
"PFS",
"PFX",
"PGC",
"PGP",
"PGR",
"PGY",
"PGZ",
"PHD",
"PHG",
"PHH",
"PHI",
"PHK",
"PHM",
"PHR",
"PHT",
"PHX",
"PII",
"PIM",
"PJT",
"PKE",
"PKG",
"PKX",
"PLD",
"PLG",
"PLL",
"PLX",
"PMF",
"PML",
"PMM",
"PMN",
"PMO",
"PMT",
"PMX",
"PNC",
"PNF",
"PNI",
"PNR",
"PNW",
"POR",
"PPC",
"PPG",
"PPL",
"PPT",
"PRA",
"PRE",
"PRG",
"PRH",
"PRI",
"PRK",
"PRM",
"PRO",
"PRS",
"PRT",
"PRU",
"PSA",
"PSF",
"PSN",
"PSO",
"PSX",
"PTA",
"PTC",
"PTN",
"PTY",
"PUK",
"PVH",
"PVL",
"PWM",
"PWP",
"PWR",
"PXS",
"PYN",
"PYT",
"PZC",
"PZG",
"QSG",
"QSI",
"QSR",
"QXO",
"RAY",
"RBA",
"RBB",
"RBC",
"RCB",
"RCC",
"RCD",
"RCG",
"RCI",
"RCL",
"RCS",
"RCT",
"RDI",
"RDN",
"RDW",
"RDY",
"REE",
"REG",
"REI",
"RES",
"REX",
"RFI",
"RFL",
"RFM",
"RGA",
"RGC",
"RGP",
"RGR",
"RGS",
"RGT",
"RHI",
"RHP",
"RIG",
"RIO",
"RIV",
"RJF",
"RKT",
"RLI",
"RLJ",
"RLX",
"RMD",
"RMI",
"RMM",
"RMR",
"RMT",
"RNA",
"RNG",
"RNP",
"RNR",
"RNW",
"ROG",
"ROK",
"ROL",
"ROP",
"RPD",
"RPM",
"RPT",
"RQI",
"RRC",
"RRR",
"RRX",
"RSF",
"RSG",
"RSI",
"RTC",
"RTO",
"RTX",
"RUM",
"RUN",
"RVP",
"RVT",
"RWT",
"RXO",
"RXT",
"RYI",
"RYN",
"RZB",
"RZC",
"SAG",
"SAH",
"SAJ",
"SAM",
"SAN",
"SAP",
"SAR",
"SAT",
"SAY",
"SAZ",
"SBC",
"SBH",
"SBI",
"SBR",
"SBS",
"SCD",
"SCI",
"SCL",
"SCM",
"SCS",
"SDA",
"SEB",
"SEE",
"SEG",
"SEI",
"SEM",
"SER",
"SES",
"SFB",
"SFD",
"SFL",
"SFM",
"SGA",
"SGC",
"SGD",
"SGI",
"SGN",
"SGU",
"SHC",
"SHG",
"SHO",
"SHW",
"SID",
"SIF",
"SIG",
"SII",
"SIM",
"SJM",
"SJT",
"SJW",
"SKE",
"SKK",
"SKM",
"SKT",
"SKX",
"SKY",
"SLB",
"SLE",
"SLF",
"SLG",
"SLI",
"SLM",
"SLN",
"SLP",
"SLS",
"SMA",
"SMC",
"SMG",
"SMP",
"SMR",
"SMX",
"SNA",
"SND",
"SNN",
"SNT",
"SNV",
"SNX",
"SNY",
"SOC",
"SOL",
"SON",
"SOR",
"SOS",
"SPB",
"SPE",
"SPG",
"SPH",
"SPR",
"SPT",
"SQM",
"SRE",
"SRG",
"SRI",
"SRL",
"SRM",
"SRV",
"SSB",
"SSD",
"SSL",
"SSP",
"SST",
"SSY",
"STC",
"STE",
"STG",
"STI",
"STK",
"STM",
"STN",
"STR",
"STT",
"STX",
"STZ",
"SUI",
"SUN",
"SUP",
"SUZ",
"SVC",
"SVM",
"SVT",
"SVV",
"SWI",
"SWK",
"SWX",
"SWZ",
"SXC",
"SXI",
"SXT",
"SYF",
"SYK",
"SYM",
"SYT",
"SYY",
"T^A",
"T^C",
"TAC",
"TAK",
"TAL",
"TAP",
"TBB",
"TBH",
"TBI",
"TBN",
"TCI",
"TCX",
"TDC",
"TDF",
"TDG",
"TDS",
"TDW",
"TDY",
"TEF",
"TEI",
"TEL",
"TEM",
"TEN",
"TEO",
"TER",
"TEX",
"TFC",
"TFX",
"TGB",
"TGI",
"TGL",
"TGS",
"TGT",
"THC",
"THG",
"THM",
"THO",
"THQ",
"THR",
"THS",
"THW",
"TIC",
"TIL",
"TJX",
"TKC",
"TKO",
"TKR",
"TLF",
"TLK",
"TLN",
"TLS",
"TLX",
"TMC",
"TME",
"TMO",
"TMP",
"TMQ",
"TNC",
"TNK",
"TNL",
"TOI",
"TOL",
"TOP",
"TPB",
"TPC",
"TPG",
"TPH",
"TPL",
"TPR",
"TRC",
"TRI",
"TRN",
"TRP",
"TRS",
"TRT",
"TRU",
"TRV",
"TRX",
"TSE",
"TSI",
"TSM",
"TSN",
"TSQ",
"TTC",
"TTD",
"TTE",
"TTI",
"TVC",
"TVE",
"TWG",
"TWI",
"TWN",
"TWO",
"TXG",
"TXN",
"TXO",
"TXT",
"TY^",
"TYG",
"TYL",
"UAA",
"UAL",
"UAN",
"UBS",
"UBX",
"UCB",
"UCL",
"UDR",
"UEC",
"UFG",
"UFI",
"UGI",
"UGP",
"UHG",
"UHS",
"UHT",
"UIS",
"ULH",
"ULS",
"ULY",
"UMC",
"UMH",
"UNB",
"UNF",
"UNH",
"UNM",
"UNP",
"UPB",
"UPC",
"UPS",
"URG",
"URI",
"USA",
"USB",
"USM",
"UTF",
"UTG",
"UTI",
"UTL",
"UTZ",
"UUU",
"UVE",
"UVV",
"UZD",
"UZE",
"UZF",
"VAC",
"VAL",
"VBF",
"VCV",
"VEL",
"VET",
"VFC",
"VFF",
"VFL",
"VFS",
"VGI",
"VGM",
"VGZ",
"VHC",
"VHI",
"VIK",
"VIR",
"VIV",
"VKI",
"VKQ",
"VLN",
"VLO",
"VLT",
"VLY",
"VMC",
"VMD",
"VMI",
"VMO",
"VNO",
"VNT",
"VOC",
"VOD",
"VOR",
"VPG",
"VPV",
"VRA",
"VRE",
"VRM",
"VRN",
"VRT",
"VSA",
"VSH",
"VST",
"VTN",
"VTR",
"VTS",
"VVR",
"VVV",
"VVX",
"VYX",
"WAB",
"WAI",
"WAL",
"WAT",
"WAY",
"WBA",
"WBD",
"WBS",
"WBX",
"WCC",
"WCN",
"WCT",
"WDC",
"WDH",
"WDI",
"WDS",
"WEA",
"WEC",
"WEN",
"WES",
"WEX",
"WFC",
"WFF",
"WFG",
"WGO",
"WGS",
"WHD",
"WHF",
"WHG",
"WHR",
"WIA",
"WIT",
"WIW",
"WIX",
"WKC",
"WLK",
"WLY",
"WMB",
"WMG",
"WMK",
"WMS",
"WMT",
"WNC",
"WNS",
"WNW",
"WOK",
"WOR",
"WOW",
"WPC",
"WPM",
"WPP",
"WRB",
"WRD",
"WRN",
"WSC",
"WSM",
"WSO",
"WSR",
"WST",
"WTF",
"WTI",
"WTM",
"WTO",
"WTS",
"WTW",
"WVE",
"WWD",
"WWR",
"WWW",
"WXM",
"WYY",
"XBP",
"XCH",
"XEL",
"XGN",
"XHG",
"XHR",
"XIN",
"XLO",
"XOM",
"XOS",
"XPL",
"XPO",
"XRX",
"XYF",
"XYL",
"XYZ",
"YHC",
"YMM",
"YOU",
"YPF",
"YRD",
"YSG",
"YUM",
"YXT",
"ZBH",
"ZEO",
"ZGN",
"ZIM",
"ZIP",
"ZJK",
"ZKH",
"ZTO",
"ZTR",
"ZTS",
"ZWS"
]

# private_key = base64.b64decode(os.getenv("SF_FQ15637_PRIVATE_KEY"))
# dbt Configuration
PROJECT_ROOT_PATH = Path(__file__).parent.parent / "YFINANCE"

# --- /Configuration ---
@dag(
    dag_id="YFINANCE_DATA_LOAD",
    start_date=pendulum.datetime(2025, 4, 1, tz="UTC"),
    schedule="@daily",
    catchup=False,
    tags=["data"],
    default_args={"retries": 1, "retry_delay": pendulum.duration(minutes=5)},
)
def yahoo_finance_pipeline():
    ensure_schema_exist = SnowflakeSqlApiOperator(
        task_id="yfinance_table_check",
        snowflake_conn_id=SF_CONN,
        sql=f"""
                CREATE SCHEMA IF NOT EXISTS {SF_DB}.{SF_SCHEMA};
            """,
    )
    ensure_table_exist = SnowflakeSqlApiOperator(
        task_id="create_table",
        snowflake_conn_id=SF_CONN,
        sql=f"""
            CREATE TABLE IF NOT EXISTS {SF_DB}.{SF_SCHEMA}.{YFINANCE_TABLE} (
                DATE TIMESTAMP_NTZ,
                OPEN FLOAT,
                HIGH FLOAT,
                LOW FLOAT,
                CLOSE FLOAT,
                ADJ_CLOSE FLOAT,
                VOLUME NUMBER,
                DIVIDENDS FLOAT,
                STOCK_SPLITS FLOAT,
                TICKER VARCHAR,
                LOADTIMESTAMP TIMESTAMP_NTZ
    );
    """,
    )

    @task
    def extract_load_yahoo_finance(
        tickers: list[str],
        conn_id: str,
        db: str,
        schema: str,
        table: str,
        logical_date,  # Airflow injects this!
    ):
        """
        Task to extract data for the previous day and load it into Snowflake.
        """
        # Calculate start and end dates for the previous day based on logical_date
        # logical_date is the *start* of the DAG run interval
        end_date_str = logical_date
        start_date = pendulum.from_format(logical_date, "YYYY-MM-DD", tz="UTC")
        start_date = start_date.subtract(years=25)  # Use subtract for clarity
        start_date_str = start_date.to_date_string()
        print(
            f"Fetching data from {start_date_str} up to (but not including) {end_date_str}"
        )

        fetch_and_load_stock_data(
            tickers=tickers,
            snowflake_conn_id=conn_id,
            database=db,
            schema=schema,
            table_name=table,
            start_date_str=start_date_str,
            end_date_str=end_date_str,
        )

    # Task to run the extraction and loading function
    fetch_and_load_task = extract_load_yahoo_finance(
        tickers=TICKERS_TO_FETCH,
        conn_id=SF_CONN,
        db=SF_DB,
        schema=SF_SCHEMA,
        table=YFINANCE_TABLE,
        logical_date="{{ ds }}",  # Pass logical_date using Airflow's macro
    )

    start = EmptyOperator(task_id="start")
    end = EmptyOperator(task_id="end")

    # Define dependencies
    (
        start
        >> ensure_schema_exist
        >> ensure_table_exist
        >> fetch_and_load_task
        >> end
    )


# Instantiate the DAG
yahoo_finance_pipeline()